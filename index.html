<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FB é•·æ–‡ç ´åœˆç”¢ç”Ÿå™¨ App</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; color: #333; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #2c3e50; }
        .api-box { background-color: #d1ecf1; padding: 15px; border-radius: 5px; border-left: 4px solid #17a2b8; margin-bottom: 20px; }
        .section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        textarea, input[type="text"], input[type="url"], select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 15px;}
        button { background-color: #3498db; color: white; border: none; padding: 10px 20px; font-size: 16px; border-radius: 5px; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #95a5a6; cursor: not-allowed; }
        .btn-image { background-color: #8e44ad; }
        .btn-image:hover { background-color: #7d3c98; }
        .btn-download { background-color: #27ae60; font-size: 14px; padding: 8px 16px; }
        .btn-download:hover { background-color: #229954; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .feedback-box { background-color: #e8f6f3; padding: 15px; border-radius: 5px; border-left: 4px solid #1abc9c; min-height: 100px; white-space: pre-wrap;}
        .loading { display: none; color: #e67e22; font-weight: bold; margin-top: 10px; }

        /* åœ–ç‰‡ç›¸é—œæ¨£å¼ */
        .image-box {
            background-color: #f8f0ff;
            border: 2px dashed #c39bd3;
            border-radius: 10px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        .image-box img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            border-radius: 8px;
        }
        .image-placeholder {
            color: #c39bd3;
            font-size: 14px;
            text-align: center;
            padding: 20px;
        }
        .image-cover-box {
            width: 300px;
            height: 300px;
            margin: 15px auto 0;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #c39bd3;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f0ff;
        }
        .image-cover-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .style-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        .style-btn {
            background: white;
            color: #8e44ad;
            border: 2px solid #c39bd3;
            padding: 8px 6px;
            font-size: 13px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            text-align: center;
        }
        .style-btn:hover, .style-btn.active {
            background: #8e44ad;
            color: white;
            border-color: #8e44ad;
        }
        .image-actions { text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸš€ FB é•·æ–‡ç”Ÿæˆèˆ‡ç·¨ä¿® App (n8n éš±å½¢å¾Œç«¯ç‰ˆ)</h1>

    <div class="api-box">
        <label for="webhookUrl"><strong>ğŸ”— æ–‡å­— Webhookï¼ˆn8n Production URLï¼‰ï¼š</strong></label>
        <input type="url" id="webhookUrl" placeholder="ä¾‹å¦‚ï¼šhttps://ä½ çš„n8nä¸»æ©Ÿ/webhook/fb-app">
        <label for="webhookImageUrl" style="margin-top:10px; display:block;"><strong>ğŸ¨ ç”¢åœ– Webhookï¼ˆn8n Production URLï¼‰ï¼š</strong></label>
        <input type="url" id="webhookImageUrl" placeholder="ä¾‹å¦‚ï¼šhttps://ä½ çš„n8nä¸»æ©Ÿ/webhook/fb-image">
        <p style="font-size: 13px; margin-top: 5px; color: #555;">ğŸ’¡ å°æé†’ï¼šOpenAI / Gemini é‡‘é‘°å·²å®‰å…¨é–åœ¨ n8n è£¡ï¼Œç¶²é ç«¯ä¸éœ€è¼¸å…¥ï¼</p>
    </div>

    <div class="section">
        <h2>0. æ‰¾å°‹ç†±é–€å½±ç‰‡éˆæ„Ÿ</h2>
        <div class="grid">
            <div>
                <select id="videoCategory" onchange="toggleCustom()">
                    <option value="è‡ªæˆ‘å°è©± / äººéš›é—œä¿‚ / å€‹äººæˆé•·">ğŸŒ± å¿ƒéˆ (è‡ªæˆ‘å°è©± / äººéš›é—œä¿‚ / å€‹äººæˆé•·)</option>
                    <option value="ç¡çœ ç§‘å­¸ / é£²é£Ÿç¿’æ…£ / èº«é«”ä¿å¥">ğŸ å¥åº· (ç¡çœ ç§‘å­¸ / é£²é£Ÿç¿’æ…£ / èº«é«”ä¿å¥)</option>
                    <option value="AI è¶¨å‹¢ / è·å ´è®ŠåŒ– / ç¤¾æœƒç¾è±¡">ğŸ“° æ™‚äº‹ (AI è¶¨å‹¢ / è·å ´è®ŠåŒ– / ç¤¾æœƒç¾è±¡)</option>
                    <option value="ç†è²¡è§€å¿µ / è²¡å‹™è‡ªç”± / æ”¶å…¥æˆé•·">ğŸ’° é‡‘éŒ¢ (ç†è²¡è§€å¿µ / è²¡å‹™è‡ªç”± / æ”¶å…¥æˆé•·)</option>
                    <option value="custom">âœï¸ è‡ªè¨‚å…¶ä»–é—œéµå­—...</option>
                </select>
                <input type="text" id="customKeyword" placeholder="è«‹è¼¸å…¥æƒ³æ‰¾çš„é—œéµå­—..." style="display: none;">
                <button id="btnFind" onclick="findVideos()">ğŸ” è«‹ AI æ¨è–¦å½±ç‰‡</button>
                <div id="loadingFind" class="loading">â³ å°‹æ‰¾å½±ç‰‡ä¸­ï¼Œè«‹ç¨å€™...</div>
            </div>
            <div>
                <textarea id="videoOutput" rows="7" placeholder="æ¨è–¦å½±ç‰‡æœƒé¡¯ç¤ºåœ¨é€™è£¡..."></textarea>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>1. ç”¢å‡ºåˆç¨¿ (è²¼ä¸Š NotebookLM å ±å‘Š)</h2>
        <textarea id="notebookInput" rows="5" placeholder="è²¼ä¸Š NotebookLM å ±å‘Š..."></textarea>
        <button id="btnGen" onclick="generateArticle()">âœ¨ ä¸€éµç”Ÿæˆæ–‡ç« </button>
        <div id="loadingGen" class="loading">â³ AI å¯«ä½œä¸­...</div>

        <!-- æ–‡ç« ç”Ÿæˆå¾Œè‡ªå‹•å‡ºç¾çš„å°é¢åœ–å€ -->
        <div id="coverSection" style="display:none; margin-top: 20px; padding-top: 15px; border-top: 1px dashed #c39bd3;">
            <h3>ğŸ¨ è‡ªå‹•ç”¢å°é¢åœ–</h3>
            <p style="font-size: 13px; color: #777;">æ ¹æ“šæ–‡ç« ä¸»é¡Œï¼ŒGemini è‡ªå‹•ç”Ÿæˆæ­£æ–¹å½¢å°é¢åœ–</p>
            <div style="margin-top: 8px;">
                <label style="font-size: 14px; font-weight: bold; color: #8e44ad;">é¸æ“‡é¢¨æ ¼ï¼š</label>
                <div class="style-grid" id="coverStyleGrid">
                    <button class="style-btn active" onclick="selectStyle('cover', this, 'æ°´å½©æ‰‹ç¹ªé¢¨ï¼Œæº«æš–æŸ”å’Œè‰²èª¿ï¼Œè¼•é€æ˜äº®')">ğŸ¨ æ°´å½©æ‰‹ç¹ª</button>
                    <button class="style-btn" onclick="selectStyle('cover', this, 'æ²¹ç•«é¢¨æ ¼ï¼Œé£½å’Œè‰²å½©ï¼Œåšå¯¦ç­†è§¸')">ğŸ–¼ï¸ æ²¹ç•«é¢¨</button>
                    <button class="style-btn" onclick="selectStyle('cover', this, 'æ‰å¹³æ’ç•«é¢¨ï¼Œå¹¾ä½•è‰²å¡Šï¼Œç¾ä»£ç°¡æ½”')">ğŸ“ æ‰å¹³æ’ç•«</button>
                    <button class="style-btn" onclick="selectStyle('cover', this, 'é‰›ç­†ç´ æç·šæ¢ï¼Œé»‘ç™½ï¼Œç´°è†©æ‰‹ç¹ªè³ªæ„Ÿ')">âœï¸ ç·šæ¢ç´ æ</button>
                    <button class="style-btn" onclick="selectStyle('cover', this, 'æ”å½±å¯«å¯¦é¢¨æ ¼ï¼Œé«˜ç•«è³ªï¼Œè‡ªç„¶å…‰')">ğŸ“· æ”å½±å¯«å¯¦</button>
                    <button class="style-btn" onclick="selectStyle('cover', this, 'è³½åšé¾å…‹ï¼Œéœ“è™¹ç‡ˆï¼Œç§‘æŠ€æ„Ÿï¼Œæ·±è‰²èƒŒæ™¯')">ğŸŒƒ è³½åšé¾å…‹</button>
                </div>
            </div>
            <button id="btnCoverImg" class="btn-image" onclick="generateCoverImage()">ğŸ–¼ï¸ ç”Ÿæˆå°é¢åœ–</button>
            <div id="loadingCoverImg" class="loading">â³ Gemini ç¹ªåœ–ä¸­ï¼Œè«‹ç¨å€™ (ç´„ 15-30 ç§’)...</div>
            <div class="image-cover-box" id="coverImgBox">
                <div class="image-placeholder">å°é¢åœ–æœƒé¡¯ç¤ºåœ¨é€™è£¡<br>ï¼ˆæ­£æ–¹å½¢ 1:1ï¼‰</div>
            </div>
            <div class="image-actions" id="coverImgActions" style="display:none;">
                <button class="btn-download" onclick="downloadImage('coverImg', 'å°é¢åœ–')">â¬‡ï¸ ä¸‹è¼‰å°é¢åœ–</button>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>2. äººæ©Ÿå”ä½œç·¨ä¿®å€</h2>
        <div class="grid">
            <div>
                <h3>âœï¸ æ–‡ç« ç·¨è¼¯å€ (å¯æ‰‹å‹•ä¿®æ”¹)</h3>
                <textarea id="articleEditor" rows="18"></textarea>
            </div>
            <div>
                <h3>ğŸ§  AI æ•™ç·´åˆ†æå ±å‘Š</h3>
                <div id="analysisOutput" class="feedback-box">åˆ†æçµæœ...</div>
                <input type="text" id="userFeedback" placeholder="è¼¸å…¥ä¿®æ”¹è§€é» (ä¾‹å¦‚ï¼šèªæ°£å†å¼·çƒˆä¸€é»)">
                <button id="btnRefine" onclick="refineArticle()">ğŸ”„ åˆ†æä¸¦å±€éƒ¨æ”¹å¯«</button>
                <div id="loadingRefine" class="loading">â³ æ•™ç·´åˆ†æèˆ‡æ”¹å¯«ä¸­...</div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>3. ç¸½ç·¨æœ€çµ‚å¯©ç¨¿</h2>
        <button id="btnFinal" onclick="finalAnalysis()">âœ… é€²è¡Œæœ€å¾Œæª¢æŸ¥</button>
        <div id="loadingFinal" class="loading">â³ ç¸½ç·¨æª¢æŸ¥ä¸­...</div>
        <div id="finalOutput" class="feedback-box" style="margin-top: 10px;"></div>
    </div>

    <div class="section">
        <h2>4. ğŸ¨ ç¨ç«‹ç”¢åœ–å€ (Gemini Imagen)</h2>
        <p style="font-size: 14px; color: #555;">è¼¸å…¥åœ–ç‰‡æè¿°ï¼Œé¸æ“‡é¢¨æ ¼ï¼Œç”Ÿæˆæ­£æ–¹å½¢åœ–ç‰‡</p>
        <div class="grid">
            <div>
                <label style="font-size: 14px; font-weight: bold;">åœ–ç‰‡æè¿°ï¼š</label>
                <textarea id="imagePromptInput" rows="4" placeholder="ä¾‹å¦‚ï¼šä¸€å€‹äººç«™åœ¨å±±é ‚çœ‹å¤•é™½ï¼Œæ„Ÿå—è‡ªç”±èˆ‡å»£é—Šï¼Œè±¡å¾µçªç ´è‡ªæˆ‘..."></textarea>

                <label style="font-size: 14px; font-weight: bold; color: #8e44ad; margin-top: 12px; display:block;">é¸æ“‡é¢¨æ ¼ï¼š</label>
                <div class="style-grid" id="standaloneStyleGrid">
                    <button class="style-btn active" onclick="selectStyle('standalone', this, 'æ°´å½©æ‰‹ç¹ªé¢¨ï¼Œæº«æš–æŸ”å’Œè‰²èª¿ï¼Œè¼•é€æ˜äº®')">ğŸ¨ æ°´å½©æ‰‹ç¹ª</button>
                    <button class="style-btn" onclick="selectStyle('standalone', this, 'æ²¹ç•«é¢¨æ ¼ï¼Œé£½å’Œè‰²å½©ï¼Œåšå¯¦ç­†è§¸')">ğŸ–¼ï¸ æ²¹ç•«é¢¨</button>
                    <button class="style-btn" onclick="selectStyle('standalone', this, 'æ‰å¹³æ’ç•«é¢¨ï¼Œå¹¾ä½•è‰²å¡Šï¼Œç¾ä»£ç°¡æ½”')">ğŸ“ æ‰å¹³æ’ç•«</button>
                    <button class="style-btn" onclick="selectStyle('standalone', this, 'é‰›ç­†ç´ æç·šæ¢ï¼Œé»‘ç™½ï¼Œç´°è†©æ‰‹ç¹ªè³ªæ„Ÿ')">âœï¸ ç·šæ¢ç´ æ</button>
                    <button class="style-btn" onclick="selectStyle('standalone', this, 'æ”å½±å¯«å¯¦é¢¨æ ¼ï¼Œé«˜ç•«è³ªï¼Œè‡ªç„¶å…‰')">ğŸ“· æ”å½±å¯«å¯¦</button>
                    <button class="style-btn" onclick="selectStyle('standalone', this, 'è³½åšé¾å…‹ï¼Œéœ“è™¹ç‡ˆï¼Œç§‘æŠ€æ„Ÿï¼Œæ·±è‰²èƒŒæ™¯')">ğŸŒƒ è³½åšé¾å…‹</button>
                </div>

                <button id="btnGenImg" class="btn-image" onclick="generateStandaloneImage()">ğŸ¨ ç«‹å³ç”¢åœ–</button>
                <div id="loadingGenImg" class="loading">â³ Gemini ç¹ªåœ–ä¸­ï¼Œè«‹ç¨å€™ (ç´„ 15-30 ç§’)...</div>
            </div>
            <div>
                <label style="font-size: 14px; font-weight: bold;">ç”Ÿæˆçµæœï¼ˆæ­£æ–¹å½¢ 1:1ï¼‰ï¼š</label>
                <div class="image-box" id="standaloneImgBox" style="height: 300px; margin-top: 5px;">
                    <div class="image-placeholder">ğŸ–¼ï¸<br>åœ–ç‰‡æœƒé¡¯ç¤ºåœ¨é€™è£¡</div>
                </div>
                <div class="image-actions" id="standaloneImgActions" style="display:none; margin-top:8px;">
                    <button class="btn-download" onclick="downloadImage('standaloneImg', 'ç”¢åœ–')">â¬‡ï¸ ä¸‹è¼‰åœ–ç‰‡</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const SYSTEM_PROMPT = `
ä½ æ˜¯ä¸€ä½è³‡æ·±ç¤¾ç¾¤å¯«ä½œæ•™ç·´èˆ‡å°ˆæ¥­æ–‡æ¡ˆã€‚ä»»å‹™ï¼šè«‹æŠŠä½¿ç”¨è€…æä¾›çš„æ–‡ç« ï¼Œæ”¹å¯«æˆä¸€ç¯‡è‡‰æ›¸è²¼æ–‡ï¼Œç›¡é‡ä¿ç•™åŸæ–‡è³‡è¨Šè±å¯Œåº¦èˆ‡ç´°ç¯€ï¼ŒåŒ…å«ç ”ç©¶å‡ºè™•ã€é—œéµæ•¸æ“šã€åäººæ¡ˆä¾‹ã€çœŸå¯¦å°ç™½ï¼Œä¸è¦éåº¦åˆªæ¸›ï¼Œä¹Ÿä¸è¦æ†‘ç©ºæé€ ï¼Œæ–‡ç« è‡³å°‘ 1200ï½1500 å­—ä»¥ä¸Šã€‚é¢¨æ ¼ï¼šå£èªåŒ–ï¼Œç…½æƒ…ã€ä½†ä¸èªªæ•™ã€‚æƒ…ç·’è¡¨é”è±å¯Œï¼ˆé©šè¨ã€æ•¬ç•ã€æ‡¸å¿µã€ææ‡¼ã€ç„¦æ…®ã€æ†¤æ€’ã€å¥½ç¬‘ã€æ„Ÿå‹•ï¼‰ã€‚è³‡è¨Šå¯†åº¦é«˜ã€é•·çŸ­å¥äº¤éŒ¯ã€‚æ³¨æ„ï¼šä¸è¦éåº¦æƒ³è¦èªªæœä»–äººã€ä¸è¦æŠŠè®€è€…ç•¶ç™½ç™¡ã€‚
ã€çµ•å°ç¦ç”¨ä»¥ä¸‹è©å½™èˆ‡å¥å‹ã€‘ï¼š
ã€Œä¸æ˜¯ï¼¯ï¼¯è€Œæ˜¯ï¼¯ï¼¯ã€å…¶å¯¦å¾ˆï¼¯ï¼¯ã€å¾ä¾†ä¸æ˜¯ã€æº«æŸ”æé†’ã€é€™ä¸æ˜¯å¶ç„¶ã€å¾ˆç©©ã€åœä½ã€æ’ä½ã€å†·æ‰ã€å®‰éœã€æ®˜é…·ã€å¾ˆç›´æ¥ã€èµ°å¾—å¾ˆæ·±ã€èƒŒè„Šç™¼æ¶¼ã€é™°é™½æ€ªæ°£ã€å…¶å¯¦å¾ˆå–®ç´”ã€å†æ™®é€šä¸éçš„ã€ç•™ä¸‹ä¸€å¥è©±ã€è€Œæ˜¯é¡˜æ„èªªä¸€å¥ã€å›é ­çœ‹ã€å¾ˆåƒã€å€¼å¾—æ·±æ€ã€ä»¤äººæ·±æ€ã€å¼•äººæ·±æ€ã€ä¸ç¦è®“äººã€ä¸å¾—ä¸èªªã€æ¯«ç„¡ç–‘å•ã€è®“æˆ‘å€‘ã€è©¦æƒ³ã€æƒ³åƒä¸€ä¸‹ã€
ã€æ ¼å¼æ›´æ­£èˆ‡æ¨™è¨»é™åˆ¶ã€‘ï¼š
1. å»é™¤åˆ†éš”ç·šã€è¡¨æƒ…ç¬¦è™Ÿèˆ‡ä¸»é¡Œæ¨™ç±¤åŠå…¶å…§å®¹ã€‚
2. ç¬¬ä¸€æ¬¡å‡ºç¾äººåæ™‚ï¼Œåœ¨ä¸­è­¯åå¾ŒåŠ è¨»è‹±æ–‡åŸåã€‚
3. å…§æ–‡åˆ†æ®µæ¨™é¡Œå‰ç½®å…¥ï¼šâ–‹
4. æ–‡ç« æ¨™é¡Œæ ¼å¼ï¼š\nã€ä¸»æ¨™ã€‘\nâ€”â€” å‰¯æ¨™
    `;

    // é¢¨æ ¼ç‹€æ…‹å­˜å„²
    const selectedStyles = {
        cover: 'æ°´å½©æ‰‹ç¹ªé¢¨ï¼Œæº«æš–æŸ”å’Œè‰²èª¿ï¼Œè¼•é€æ˜äº®',
        standalone: 'æ°´å½©æ‰‹ç¹ªé¢¨ï¼Œæº«æš–æŸ”å’Œè‰²èª¿ï¼Œè¼•é€æ˜äº®'
    };

    function selectStyle(type, el, style) {
        selectedStyles[type] = style;
        const gridId = type === 'cover' ? 'coverStyleGrid' : 'standaloneStyleGrid';
        document.querySelectorAll(`#${gridId} .style-btn`).forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }

    function toggleCustom() {
        document.getElementById('customKeyword').style.display =
            document.getElementById('videoCategory').value === 'custom' ? 'block' : 'none';
    }

    // å¾ n8n å›å‚³çš„ JSON ä¸­è‡ªå‹•èƒå–æ–‡å­—å…§å®¹
    function extractTextFromN8n(data) {
        const obj = Array.isArray(data) ? data[0] : data;
        if (!obj) return null;
        const candidates = [
            obj.text, obj.output, obj.message, obj.content, obj.result, obj.response,
            obj?.choices?.[0]?.message?.content,
            obj?.choices?.[0]?.text,
            obj?.json?.text, obj?.json?.output,
        ];
        for (const val of candidates) {
            if (typeof val === 'string' && val.trim()) return val.trim();
        }
        return "âš ï¸ ç„¡æ³•è‡ªå‹•è§£æ n8n å›å‚³æ ¼å¼ï¼ŒåŸå§‹ JSON å¦‚ä¸‹ï¼š\n\n" + JSON.stringify(data, null, 2);
    }

    // çµ±ä¸€å‘¼å« n8n æ–‡å­— Webhook
    async function callN8n(systemPrompt, userPrompt, temperature, btnId, loadingId) {
        const webhookUrl = document.getElementById('webhookUrl').value.trim();
        if (!webhookUrl) return alert("è«‹å…ˆå¡«å¯«æ–‡å­— Webhook ç¶²å€ï¼");

        document.getElementById(btnId).disabled = true;
        document.getElementById(loadingId).style.display = 'block';

        try {
            const response = await fetch(webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ systemPrompt, userPrompt, temperature })
            });
            if (!response.ok) { alert(`n8n éŒ¯èª¤ï¼š${response.status} ${response.statusText}`); return null; }
            const data = await response.json();
            return extractTextFromN8n(data);
        } catch (error) {
            alert("âŒ é€£ç·šå¤±æ•—ï¼š" + error.message);
            return null;
        } finally {
            document.getElementById(btnId).disabled = false;
            document.getElementById(loadingId).style.display = 'none';
        }
    }

    // å‘¼å« n8n ç”¢åœ– Webhook
    async function callN8nImage(prompt, style, btnId, loadingId) {
        const webhookUrl = document.getElementById('webhookImageUrl').value.trim();
        if (!webhookUrl) return alert("è«‹å…ˆå¡«å¯«ç”¢åœ– Webhook ç¶²å€ï¼");

        document.getElementById(btnId).disabled = true;
        document.getElementById(loadingId).style.display = 'block';

        try {
            const response = await fetch(webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt, style })
            });
            if (!response.ok) { alert(`ç”¢åœ– Webhook éŒ¯èª¤ï¼š${response.status} ${response.statusText}`); return null; }
            const data = await response.json();
            const obj = Array.isArray(data) ? data[0] : data;
            // å˜—è©¦å–å¾— base64 åœ–ç‰‡ï¼Œæ”¯æ´å¤šç¨®æ¬„ä½åç¨±
            return obj.image || obj.imageBase64 || obj.base64 ||
                   obj?.predictions?.[0]?.bytesBase64Encoded || null;
        } catch (error) {
            alert("âŒ ç”¢åœ–é€£ç·šå¤±æ•—ï¼š" + error.message);
            return null;
        } finally {
            document.getElementById(btnId).disabled = false;
            document.getElementById(loadingId).style.display = 'none';
        }
    }

    // é¡¯ç¤º base64 åœ–ç‰‡åˆ°æŒ‡å®šå®¹å™¨
    function showImage(base64, mimeType, boxId, imgId, actionsId) {
        const box = document.getElementById(boxId);
        const src = base64.startsWith('data:') ? base64 : `data:${mimeType || 'image/png'};base64,${base64}`;
        box.innerHTML = `<img id="${imgId}" src="${src}" alt="ç”Ÿæˆåœ–ç‰‡">`;
        document.getElementById(actionsId).style.display = 'block';
    }

    // ä¸‹è¼‰åœ–ç‰‡
    function downloadImage(imgId, filename) {
        const img = document.getElementById(imgId);
        if (!img) return;
        const a = document.createElement('a');
        a.href = img.src;
        a.download = `${filename}_${Date.now()}.png`;
        a.click();
    }

    // æ­¥é©Ÿ 0
    async function findVideos() {
        let kw = document.getElementById('videoCategory').value;
        if (kw === 'custom') kw = document.getElementById('customKeyword').value.trim();
        if (!kw) return alert("è«‹è¼¸å…¥é—œéµå­—ï¼");
        const sys = "ä½ æ˜¯ä¸€ä½å° YouTube è¶¨å‹¢æ•éŠ³çš„ç¤¾ç¾¤ä¼åŠƒã€‚";
        const user = `å¹«æˆ‘æ‰¾ 3 æ”¯é—œæ–¼ã€${kw}ã€‘çš„ YouTube å½±ç‰‡ã€‚\næ¢ä»¶ï¼šç€è¦½è‡³å°‘ 10 è¬ã€ä¸€å¹´å…§ç™¼å¸ƒã€éä¸­æ–‡ã€çŸ¥è­˜å‹é »é“å„ªå…ˆã€‚\næ¯æ”¯è«‹çµ¦æˆ‘ï¼šæ¨™é¡Œï¼‹é€£çµï¼‹ä¸€å¥è©±èªªæ˜é©åˆæ”¹å¯«æˆä»€éº¼ä¸»é¡Œï¼‹å»ºè­°é–‹é ­è§’åº¦ã€‚`;
        const result = await callN8n(sys, user, 0.7, 'btnFind', 'loadingFind');
        if (result) document.getElementById('videoOutput').value = result;
    }

    // æ­¥é©Ÿ 1ï¼šç”Ÿæˆæ–‡ç« å¾Œé¡¯ç¤ºå°é¢åœ–å€
    async function generateArticle() {
        const text = document.getElementById('notebookInput').value;
        if (!text) return alert("è«‹è²¼ä¸Šå ±å‘Šï¼");
        const user = "ä»¥ä¸‹æ˜¯ NotebookLM æ•´ç†çš„å ±å‘Šï¼Œè«‹æ ¹æ“šè¦å‰‡å¹«æˆ‘æ”¹å¯«ï¼š\n\n" + text;
        const result = await callN8n(SYSTEM_PROMPT, user, 0.7, 'btnGen', 'loadingGen');
        if (result) {
            document.getElementById('articleEditor').value = result;
            document.getElementById('coverSection').style.display = 'block'; // é¡¯ç¤ºå°é¢åœ–å€
        }
    }

    // å°é¢åœ–ï¼šæ ¹æ“šæ–‡ç« è‡ªå‹•ç”Ÿæˆ prompt å†ç”¢åœ–
    async function generateCoverImage() {
        const article = document.getElementById('articleEditor').value;
        if (!article) return alert("è«‹å…ˆç”Ÿæˆæ–‡ç« ï¼");

        // å…ˆè«‹ AI èƒå–é©åˆç”¢åœ–çš„æè¿°
        const sys = "ä½ æ˜¯ä¸€ä½è¦–è¦ºè¨­è¨ˆå¸«ï¼Œè«‹å¾æ–‡ç« ä¸­æå–æ ¸å¿ƒæ„è±¡ï¼Œç”¨ä¸€æ®µ 80 å­—ä»¥å…§çš„è‹±æ–‡æè¿°ï¼Œé©åˆç”¨ä¾†ç”Ÿæˆä¸€å¼µæ­£æ–¹å½¢å°é¢åœ–ï¼Œæè¿°è¦å…·é«”æœ‰ç•«é¢æ„Ÿï¼Œä¸è¦å‡ºç¾ä»»ä½•æ–‡å­—ã€‚";
        const imgPrompt = await callN8n(sys, article, 0.7, 'btnCoverImg', 'loadingCoverImg');
        if (!imgPrompt) return;

        const base64 = await callN8nImage(imgPrompt, selectedStyles.cover, 'btnCoverImg', 'loadingCoverImg');
        if (base64) {
            showImage(base64, 'image/png', 'coverImgBox', 'coverImg', 'coverImgActions');
        } else {
            alert("âš ï¸ ç”¢åœ–å¤±æ•—ï¼Œè«‹ç¢ºèªç”¢åœ– Webhook è¨­å®šæ­£ç¢ºã€‚");
        }
    }

    // æ­¥é©Ÿ 2
    async function refineArticle() {
        const article = document.getElementById('articleEditor').value;
        const fb = document.getElementById('userFeedback').value;
        if (!article) return alert("è«‹ç¢ºèªç·¨è¼¯å€æœ‰æ–‡ç« ï¼");
        document.getElementById('analysisOutput').innerText = "AI æ•™ç·´æ­£åœ¨åˆ†ææ–‡ç« ...";
        const sys1 = "ä½ æ˜¯ä¸€ä½è³‡æ·±ç¤¾ç¾¤å¯«ä½œæ•™ç·´ï¼Œè«‹åˆ†æé€™ç¯‡æ–‡ç« çš„é¢¨æ ¼èˆ‡å„ªç¼ºé»ï¼Œä»¥åŠå¯å„ªåŒ–çš„åœ°æ–¹ã€‚";
        const user1 = `é€™æ˜¯ç›®å‰å¯«å¥½çš„æ–‡ç« ï¼š\n\n${article}\n\næˆ‘çš„é¡å¤–å„ªåŒ–è¦æ±‚/è§€é»ï¼š${fb}`;
        const analysisResult = await callN8n(sys1, user1, 0.7, 'btnRefine', 'loadingRefine');
        if (!analysisResult) return;
        document.getElementById('analysisOutput').innerText = analysisResult;
        const user2 = `é€™æ˜¯åŸæ–‡ç« ï¼š\n${article}\n\né€™æ˜¯æ•™ç·´çš„åˆ†æèˆ‡å„ªåŒ–å»ºè­°ï¼š\n${analysisResult}\n\nä»»å‹™ï¼šè«‹æŒ‰ç…§æ•™ç·´æä¾›çš„æ–¹å‘èª¿æ•´ã€‚åŸæ–‡ç›¡é‡ä¸æ”¹å‹•ï¼Œåªèª¿æ•´å¿…è¦èª¿æ•´çš„åœ°æ–¹ï¼Œä¸è¦å¾é ­åˆ°å°¾æ”¹å¯«ã€‚ä¸è¦èˆ‡æˆ‘äº’å‹•èˆ‡å°è©±ï¼Œç›´æ¥çµ¦æˆ‘ä¿®æ”¹å¾Œçš„æ–‡ç« ã€‚`;
        const newArticle = await callN8n(SYSTEM_PROMPT, user2, 0.5, 'btnRefine', 'loadingRefine');
        if (newArticle) document.getElementById('articleEditor').value = newArticle;
    }

    // æ­¥é©Ÿ 3
    async function finalAnalysis() {
        const article = document.getElementById('articleEditor').value;
        if (!article) return alert("è«‹ç¢ºèªç·¨è¼¯å€æœ‰æ–‡ç« ï¼");
        const sys = "ä½ æ˜¯ä¸€ä½åš´æ ¼çš„ç¤¾ç¾¤å…§å®¹ç¸½ç·¨ã€‚è«‹ç¢ºèªï¼š1. èªæ°£æ˜¯å¦è‡ªç„¶ã€2. ç¯€å¥æ˜¯å¦é †æš¢ã€3. æœ‰ç„¡é‚è¼¯ç›²é»æˆ–éŒ¯å­—ã€‚æ¢åˆ—çµ¦å›é¥‹ï¼Œã€ä¸è¦ã€‘é‡æ–°æ”¹å¯«æ–‡ç« ã€‚";
        const user = "é€™æ˜¯æˆ‘äººå·¥ç²¾ä¿®å¾Œçš„æ–‡ç« ï¼Œè«‹å¹«æˆ‘åšæœ€å¾Œåˆ†æï¼š\n\n" + article;
        const result = await callN8n(sys, user, 0.3, 'btnFinal', 'loadingFinal');
        if (result) document.getElementById('finalOutput').innerText = result;
    }

    // æ­¥é©Ÿ 4ï¼šç¨ç«‹ç”¢åœ–
    async function generateStandaloneImage() {
        const prompt = document.getElementById('imagePromptInput').value.trim();
        if (!prompt) return alert("è«‹è¼¸å…¥åœ–ç‰‡æè¿°ï¼");
        const base64 = await callN8nImage(prompt, selectedStyles.standalone, 'btnGenImg', 'loadingGenImg');
        if (base64) {
            showImage(base64, 'image/png', 'standaloneImgBox', 'standaloneImg', 'standaloneImgActions');
        } else {
            alert("âš ï¸ ç”¢åœ–å¤±æ•—ï¼Œè«‹ç¢ºèªç”¢åœ– Webhook è¨­å®šæ­£ç¢ºï¼Œä¸¦ç¢ºèª n8n ä¸­ Gemini API Key æœ‰æ•ˆã€‚");
        }
    }
</script>

</body>
</html>
